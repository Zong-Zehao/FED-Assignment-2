<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Song Guessing Game</title>
  <!-- Include string-similarity library -->
  <script src="https://cdn.jsdelivr.net/npm/string-similarity/umd/string-similarity.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }

    #songInfo {
      margin-top: 20px;
    }

    #score {
      margin-top: 10px;
      font-weight: bold;
    }

    #timer {
      margin-top: 10px;
      font-weight: bold;
    }

    /* Add some styling for better visibility of the track list */
    #trackList {
      margin-top: 20px;
      text-align: left;
      /* Align the track list to the left */
    }

    /* Style for individual song sections */
    .songSection {
      margin-bottom: 20px;
      text-align: center;
      /* Center the song section */
    }

    .hidden {
      display: none;
      /* Hide the element */
    }
  </style>
</head>

<body>
  <h1>Song Guessing Game</h1>
  <div>
    <label for="artistInput">Enter Artist Name:</label>
    <input type="text" id="artistInput">
    <button onclick="searchSongsByArtist()">Search Songs</button>
  </div>
  <div id="songInfo">
    <p id="trackTitle" class="hidden"></p>
    <p id="artistName"></p>
  </div>

  <!-- Add this div for displaying the track list -->
  <div id="trackList"></div>

  <div id="score">Score: 0</div>
  <div id="timer">Time: 0 seconds</div>

  <script>
    let score = 0;
    let currentTrackIndex = 0;
    let currentAudioElement;
    let addedTracks = [];
    let startTime; // Variable to store the start time

    async function searchSongsByArtist() {
      const artistName = document.getElementById('artistInput').value.trim();
      if (artistName === '') {
        alert('Please enter an artist name.');
        return;
      }

      // Reset game state
      score = 0;
      currentTrackIndex = 0;
      addedTracks = [];
      startTime = null; // Reset the start time

      const searchUrl = `https://deezerdevs-deezer.p.rapidapi.com/search?q=${artistName}`;
      const options = {
        method: 'GET',
        headers: {
          'X-RapidAPI-Key': '57c85ed06fmsh39d26ca54fd5307p130ecejsn6bd33960a5cb',
          'X-RapidAPI-Host': 'deezerdevs-deezer.p.rapidapi.com'
        }
      };

      try {
        const response = await fetch(searchUrl, options);
        const data = await response.json();

        if (data.data && data.data.length > 0) {
          // Shuffle the order of the tracks
          const shuffledTracks = shuffleArray(data.data);

          const trackListContainer = document.getElementById('trackList');
          trackListContainer.innerHTML = ''; // Clear previous content

          for (const track of shuffledTracks) {
            // Append information about the track to the trackList
            const artistName = track.artist.name;
            const trackSection = document.createElement('div');
            trackSection.className = 'songSection';
            trackSection.id = `songSection${currentTrackIndex}`;
            trackSection.innerHTML = `
                <p class="hidden">Title: ${track.title}</p>
                <p>Artist: ${artistName}</p>
                <label for="guessInput${currentTrackIndex}">Your Guess:</label>
                <input type="text" id="guessInput${currentTrackIndex}" disabled>
                <button onclick="checkGuess(${currentTrackIndex})" id="checkGuessBtn${currentTrackIndex}" disabled>Check Guess</button>
                <button onclick="skipSong(${currentTrackIndex})">Skip</button>
                <audio controls id="audio${currentTrackIndex}" onloadeddata="enableGuess(${currentTrackIndex})">
                    <source src="${track.preview}" type="audio/mp3">
                    Your browser does not support the audio element.
                </audio>
            `;
            trackListContainer.appendChild(trackSection);
            currentTrackIndex++;
          }

          // Enable the guess inputs and buttons
          document.querySelectorAll('input[type="text"]').forEach(input => (input.disabled = false));
          document.querySelectorAll('button[id^="checkGuessBtn"]').forEach(button => (button.disabled = false));

          // Show the first song section
          showSongSection(0);

          // Start the timer
          startTime = new Date().getTime();
          updateTimer(); // Initial display of the timer
        } else {
          console.log('No tracks found for the artist:', artistName);
        }
      } catch (error) {
        console.error(error);
      }
    }

    function shuffleArray(array) {
      // Function to shuffle the order of an array
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function showSongSection(index) {
      // Pause the audio from the previous song
      if (currentAudioElement) {
        currentAudioElement.pause();
      }

      // Hide all song sections
      document.querySelectorAll('.songSection').forEach(section => (section.style.display = 'none'));

      // Check if there are more songs
      if (index === currentTrackIndex - 1) {
        // Stop the timer when all songs are guessed
        updateTimer();
        startTime = null;
        // Prompt user for a new artist's name
        const newArtistName = prompt('You have guessed all the songs. Enter a new artist\'s name:');
        if (newArtistName) {
          // Perform a new search for the entered artist
          document.getElementById('artistInput').value = newArtistName;
          searchSongsByArtist();
        }
      }

      // Show the selected song section
      const selectedSection = document.getElementById(`songSection${index}`);
      if (selectedSection) {
        selectedSection.style.display = 'block';
        currentAudioElement = selectedSection.querySelector('audio');
        currentAudioElement.play(); // Start playing the new audio
      }

      // Show the score only after loading new songs
      document.getElementById('score').innerText = 'Score: ' + score;
    }

    function enableGuess(index) {
      // Enable guess input and button when audio is loaded
      document.getElementById(`guessInput${index}`).disabled = false;
      document.getElementById(`checkGuessBtn${index}`).disabled = false;
    }

    async function checkGuess(index) {
      const userGuess = document.getElementById(`guessInput${index}`).value.toLowerCase();
      const currentSection = document.getElementById(`songSection${index}`);
      const correctTitle = currentSection.querySelector('p:nth-child(1)').innerText.toLowerCase();

      // You can adjust the threshold for similarity based on your preference
      const similarityThreshold = 0.4; // Adjusted to a lower value

      if (stringSimilarity.compareTwoStrings(userGuess, correctTitle) >= similarityThreshold) {
        alert('Correct! You guessed the song.');
        score += 10; // Adjusted the points to 10 for a correct guess
        // Move to the next song after a correct guess
        showSongSection(index + 1);
      } else {
        alert('Incorrect. Try again.');
      }

      // Update the score display
      document.getElementById('score').innerText = 'Score: ' + score;
    }

    function skipSong(index) {
      // Move to the next song without guessing
      showSongSection(index + 1);
    }

    function updateTimer() {
      // Function to update and display the elapsed time
      if (startTime !== null) {
        const currentTime = new Date().getTime();
        const elapsedTime = (currentTime - startTime) / 1000; // Convert to seconds
        document.getElementById('timer').innerText = 'Time: ' + Math.floor(elapsedTime) + ' seconds';
      }
    }

    // Update the timer every second
    setInterval(updateTimer, 1000);
  </script>
</body>

</html>
